# Проект Squid - Обзор системы

## Назначение

Проект Squid - это система управления шаговыми двигателями (ШД) для применения в ЧПУ-станках. Система поддерживает до 10 шаговых двигателей с возможностью синхронного или асинхронного запуска.

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────────┐
│                              PC                                  │
│                    MotorManagerService                          │
│                      (Python/FastAPI)                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │ USB
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         FT232RL                                  │
│                    (USB ↔ UART мост)                            │
└───────────────────────────┬─────────────────────────────────────┘
                            │ USART
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      STM32F407VG                                 │
│                  (Центральный MCU)                              │
│                                                                  │
│  Управляет 10 подчиненными контроллерами через:                 │
│  - UART4 (данные) + CD4066BM (мультиплексирование)              │
│  - GPIO сигналы: EN, KEY, SELECT, STATUS                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  STM32G031F8  │   │  STM32G031F8  │   │  STM32G031F8  │
│   Мотор 1     │   │   Мотор 2     │   │  ...Мотор 10  │
│               │   │               │   │               │
│ Трапецевидный │   │ Трапецевидный │   │ Трапецевидный │
│    профиль    │   │    профиль    │   │    профиль    │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        ▼                   ▼                   ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │ Драйвер │         │ Драйвер │         │ Драйвер │
   │   ШД    │         │   ШД    │         │   ШД    │
   └────┬────┘         └────┬────┘         └────┬────┘
        │                   │                   │
        ▼                   ▼                   ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │  Мотор  │         │  Мотор  │         │  Мотор  │
   └─────────┘         └─────────┘         └─────────┘
```

## Компоненты системы

| Компонент | Описание | Репозиторий |
|-----------|----------|-------------|
| MotorManagerService | Python микросервис с WEB-интерфейсом | [MotorManagerService](https://github.com/khosta77/MotorManagerService) |
| Squid (Плата) | Электрическая схема в KiCad 9.0 | [Squid](https://github.com/khosta77/Squid) |
| SQUID_MCU | Прошивка центрального MCU (STM32F407VG) | [SQUID_MCU](https://github.com/khosta77/SQUID_MCU) |
| STM32G031x8_MOTOR_DRIVER | Прошивка контроллеров моторов | [STM32G031x8_MOTOR_DRIVER](https://github.com/khosta77/STM32G031x8_MOTOR_DRIVER) |

## Аппаратные компоненты платы

- **STM32F407VG** - центральный микроконтроллер
- **FT232RL** - USB-UART преобразователь
- **RT9193-33GB** - стабилизатор питания 5V → 3.3V
- **CD4066BM** - аналоговые ключи для мультиплексирования UART
- **STM32G031F8Px** (x10) - контроллеры управления драйверами ШД
- **SS8050 + IRLML5203** - преобразователи уровней 3.3V ↔ 5V
- **RJ45 разъемы** - подключение внешних драйверов ШД
- Концевые выключатели для каждого мотора

## Протокол связи PC ↔ MCU

### Формат команд (1 байт)

| Биты | Команда | Описание |
|------|---------|----------|
| `0x8N` | Синхронный запуск | N = количество моторов (1-10) |
| `0x4N` | Асинхронный запуск | N = количество моторов (1-10) |
| `0x20` | Запрос версии | Получение информации о прошивке |

### Примеры команд

```
0x81 - синхронный запуск 1 мотора
0x82 - синхронный запуск 2 моторов
0x8A - синхронный запуск 10 моторов
0x41 - асинхронный запуск 1 мотора
0x42 - асинхронный запуск 2 моторов
0x20 - запрос версии прошивки
```

### Структура данных мотора (16 байт)

| Параметр | Размер | Описание |
|----------|--------|----------|
| number | 4 байта (uint32_t) | Номер мотора (1-10) |
| acceleration | 4 байта (uint32_t) | Ускорение (>0) |
| maxSpeed | 4 байта (uint32_t) | Максимальная скорость (>0) |
| step | 4 байта (int32_t) | Количество шагов (может быть отрицательным) |

### JSON API

```json
{
    "mode": "synchronous",
    "motors": [
        {"number": 1, "acceleration": 2000, "maxSpeed": 5000, "step": 100},
        {"number": 2, "acceleration": 1500, "maxSpeed": 4500, "step": -50}
    ]
}
```

## Сигналы управления моторами

Для каждого мотора (x = 0-9) используются 4 типа сигналов:

| Сигнал | GPIO | Назначение |
|--------|------|------------|
| EN_x | PC0-PC9 | Подача тока на моторы (всегда включен, отключается только при аварии) |
| KEY_x | PB0-PB9 | Ключ для передачи данных по UART4 (включается только на время передачи) |
| SELECT_x | PD0-PD9 | Выбор мотора для настройки |
| STATUS_x | PE0-PE9 | Статус выполнения (1 = работает, 0 = ждет) |

## Режимы работы

### Синхронный режим (0x8N)

1. Для каждого мотора:
   - Включается SELECT_x
   - Включается KEY_x
   - Передаются данные (ускорение, скорость, шаги)
   - Ожидание STATUS = 1
   - Выключается KEY_x
   - SELECT_x **остается включенным**
2. Номера моторов сохраняются в `syncMotorBuffer`
3. Одновременный запуск: `GPIOD->ODR &= ~syncMotorBuffer`
4. Все моторы стартуют синхронно

### Асинхронный режим (0x4N)

1. Для каждого мотора:
   - Включается SELECT_x
   - Включается KEY_x
   - Передаются данные
   - Ожидание STATUS = 1
   - Выключается KEY_x
   - Выключается SELECT_x
2. Мотор начинает движение сразу после настройки

## Последовательность команды moving()

```
1. PC → MCU: Команда режима (0x8N или 0x4N)
2. MCU → PC: Подтверждение готовности (0x00 = OK)
3. PC → MCU: Данные моторов (N × 16 байт)
4. MCU: Обработка и выполнение движения
5. MCU → PC: Результат (0xFF = успех)
```

## Коды ошибок

### Ошибки готовности MCU

| Код | Описание |
|-----|----------|
| 0x01 | Некорректное количество моторов |
| 0x02 | Некорректный режим работы |
| 0x03 | MCU занят другой операцией |
| 0x04 | Недостаточно памяти |
| 0x05 | Ошибка инициализации моторов |

### Ошибки выполнения

| Код | Описание |
|-----|----------|
| 0x05 | Механическая ошибка (заклинивание) |
| 0x06 | Перегрев драйвера |
| 0x0B | Аварийная остановка |
| 0x0C | Ошибка синхронизации |
| 0x0D | Таймаут выполнения |

## Известные проблемы

1. **FT232RL нестабильность** - По временным диаграммам все корректно, но чип периодически не видит данные
2. **Отрицательные числа** - Контроллер драйвера (STM32G031) не обрабатывает отрицательные значения шагов
3. **Концевые выключатели** - Не реализована обработка сигналов с концевиков
4. **Асинхронный режим** - Нестабильное поведение
5. **cmake** - Не работает сборка через cmake

## Кодирование версии прошивки

Версия кодируется одним байтом:
- Старшие 4 бита: целая часть
- Младшие 4 бита: дробная часть
- Пример: версия 1.3 → `0x13`

## Валидация параметров

- Количество моторов: 1-10
- Номер мотора: 1-10
- Ускорение: > 0
- Максимальная скорость: > 0
- Шаги: любое целое число (включая отрицательные)
