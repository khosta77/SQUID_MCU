# Протокол MCU <-> Driver

## Аппаратный интерфейс

| Параметр | Значение |
|----------|----------|
| Интерфейс | USART2 |
| TX | PA2 |
| RX | PA3 |
| Скорость | 115200 baud |
| KEY пины | PB0-PB9 (выбор драйвера) |
| Топология | Общая шина (все драйверы на одном USART2) |

## Схема передачи данных

```
MCU                                          Driver X
 │                                               │
 ├──► KEY_X = HIGH ◄─────────────────────────────┤  Активация драйвера
 │                                               │
 ├──► USART2 TX ────────────────────────────────►│  14 байт пакета
 │                                               │
 ├───────────────────────────────────────────────┤  Ожидание ответа / таймаут
 │                                               │
 ├──► KEY_X = LOW ◄──────────────────────────────┤  Деактивация драйвера
 │                                               │
```

## Формат пакета MCU -> Driver (14 байт)

```
┌───────┬────────────┬────────────┬────────────┬───────┐
│  CMD  │   accel    │   speed    │   steps    │  XOR  │
│ 0x78  │  4 bytes   │  4 bytes   │  4 bytes   │ 1 byte│
└───────┴────────────┴────────────┴────────────┴───────┘
```

| Поле | Смещение | Размер | Тип | Описание |
|------|----------|--------|-----|----------|
| CMD | 0 | 1 | uint8 | Команда движения `0x78` |
| accel | 1 | 4 | uint32 LE | Ускорение (шаги/сек^2) |
| speed | 5 | 4 | uint32 LE | Максимальная скорость (шаги/сек) |
| steps | 9 | 4 | int32 LE | Количество шагов (отрицательное = реверс) |
| XOR | 13 | 1 | uint8 | XOR байтов 0-12 |

## Пример пакета

**Параметры:** accel=500, speed=1000, steps=5000

```
78                          # CMD: 0x78 (движение)
F4 01 00 00                 # accel: 500 (0x000001F4 LE)
E8 03 00 00                 # speed: 1000 (0x000003E8 LE)
88 13 00 00                 # steps: 5000 (0x00001388 LE)
XX                          # XOR: XOR байтов 0-12
```

## Тайминги

| Операция | Время |
|----------|-------|
| KEY HIGH -> TX start | ~10 мкс |
| TX duration (14 байт @ 115200) | ~1.2 мс |
| TX complete -> KEY LOW | ~10 мкс |
| Debug timeout (если нет ответа) | 3000 мс |

## Последовательность отправки нескольким моторам

При команде на несколько моторов, MCU отправляет пакеты последовательно:

```
Motor 1: KEY1 HIGH → TX 14 bytes → wait → KEY1 LOW
                                              │
Motor 2: ────────────────────────────────────►│ KEY2 HIGH → TX 14 bytes → wait → KEY2 LOW
                                                                                      │
Motor N: ────────────────────────────────────────────────────────────────────────────►│ ...
```

## Формат ответа Driver -> MCU

*В текущей реализации используется debug-режим с таймаутом 3 секунды вместо реального ответа от драйвера.*
