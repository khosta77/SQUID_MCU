# Протокол SQUID MCU - Описание команд

## Формат пакета

```
┌─────┬──────────┬──────────┬─────────┬────────────┬─────────┐
│ STX │ Length_H │ Length_L │ Command │ Data[0..N] │   XOR   │
│ 0x02│  1 byte  │  1 byte  │  1 byte │  N bytes   │  1 byte │
└─────┴──────────┴──────────┴─────────┴────────────┴─────────┘
```

| Поле | Размер | Описание |
|------|--------|----------|
| STX | 1 байт | Стартовый байт `0x02` |
| Length | 2 байта | Полная длина пакета (от STX до XOR включительно) |
| Command | 1 байт | Код команды/ответа |
| Data | 0-250 байт | Данные (зависит от команды) |
| XOR | 1 байт | Контрольная сумма (XOR от Length_H до последнего байта Data) |

**Важно:** STX не участвует в расчёте XOR.

## Команды (PC -> MCU)

| Код | Название | Data | Описание |
|-----|----------|------|----------|
| `0x01` | VERSION | - | Запрос версии прошивки |
| `0x02` | STATUS | - | Запрос состояния моторов |
| `0x03` | STOP | - | Остановка всех моторов |
| `0x10` | SYNC_MOVE | MotorParams[] | Синхронное движение |
| `0x11` | ASYNC_MOVE | MotorParams[] | Асинхронное движение |

## Ответы (MCU -> PC)

| Код | Название | Data | Описание |
|-----|----------|------|----------|
| `0x81` | VERSION | 1 байт (версия) | Версия прошивки |
| `0x82` | STATUS | 2 байта (active, completed) | Состояние моторов |
| `0x83` | STOP | 1 байт (result) | Результат остановки |
| `0x90` | MOVE | 1 байт (result) | Результат движения |
| `0xFF` | ERROR | 1 байт (error_code) | Ошибка |

## Коды ошибок

| Код | Название | Описание |
|-----|----------|----------|
| `0x01` | INVALID_COMMAND | Неизвестная команда |
| `0x02` | INVALID_PACKET_LENGTH | Некорректная длина пакета |
| `0x03` | XOR_CHECKSUM_ERROR | Ошибка контрольной суммы |
| `0x04` | INVALID_MOTOR_COUNT | Некорректное количество моторов |
| `0x05` | MOTOR_PARAM_ERROR | Ошибка параметров мотора |
| `0x0B` | EMERGENCY_STOP | Аварийная остановка |
| `0x0D` | TIMEOUT | Таймаут операции |

## Коды результата

| Код | Название | Описание |
|-----|----------|----------|
| `0x00` | SUCCESS | Успешное выполнение |
| `0x01` | BUSY | Система занята |

## Структура MotorParams (16 байт)

```
┌────────────┬──────────────┬───────────┬─────────┐
│   number   │ acceleration │ max_speed │  steps  │
│  uint32_t  │   uint32_t   │  uint32_t │ uint32_t│
│  4 bytes   │   4 bytes    │  4 bytes  │ 4 bytes │
└────────────┴──────────────┴───────────┴─────────┘
```

Порядок байтов: Little-Endian

| Поле | Размер | Диапазон | Описание |
|------|--------|----------|----------|
| number | 4 байта | 1-10 | Номер мотора |
| acceleration | 4 байта | > 0 | Ускорение (шаги/сек^2) |
| max_speed | 4 байта | > 0 | Максимальная скорость (шаги/сек) |
| steps | 4 байта | любое | Количество шагов (отрицательные - реверс) |

## Примеры

### VERSION (запрос версии)

**Запрос:**
```
02 00 05 01 04
│  │  │  │  └── XOR: 0x00 ^ 0x05 ^ 0x01 = 0x04
│  │  │  └────── Command: VERSION (0x01)
│  │  └───────── Length_L: 5
│  └──────────── Length_H: 0
└─────────────── STX: 0x02
```

**Ответ (версия 1.0):**
```
02 00 06 81 10 97
│  │  │  │  │  └── XOR: 0x00 ^ 0x06 ^ 0x81 ^ 0x10 = 0x97
│  │  │  │  └────── Data: 0x10 (version 1.0)
│  │  │  └───────── Response: VERSION (0x81)
│  │  └──────────── Length_L: 6
│  └───────────────  Length_H: 0
└────────────────── STX: 0x02
```

### STATUS (запрос состояния)

**Запрос:**
```
02 00 05 02 07
```

**Ответ:**
```
02 00 07 82 01 01 85
                │  │
                │  └── completed: 0x01 (мотор 1 завершил)
                └───── active: 0x01 (мотор 1 активен)
```

### SYNC_MOVE (синхронное движение 1 мотора)

**Запрос (мотор 1, accel=500, speed=1000, steps=5000):**
```
02 00 15 10                    # STX, Length=21, SYNC_MOVE
01 00 00 00                    # number=1
F4 01 00 00                    # acceleration=500
E8 03 00 00                    # max_speed=1000
88 13 00 00                    # steps=5000
XX                             # XOR
```

**Ответ (успех):**
```
02 00 06 90 00 96
```

### STOP (остановка)

**Запрос:**
```
02 00 05 03 06
```

**Ответ:**
```
02 00 06 83 00 85
```

## CLI примеры

```bash
# Версия прошивки
poetry run python scripts/cli.py version

# Состояние моторов
poetry run python scripts/cli.py status

# Остановка
poetry run python scripts/cli.py stop

# Движение мотора 1 на 5000 шагов
poetry run python scripts/cli.py move -m 1 -s 5000

# Движение с параметрами
poetry run python scripts/cli.py move -m 1 -s 5000 --speed 2000 --accel 1000

# Асинхронное движение
poetry run python scripts/cli.py move -m 1 -s 5000 --async

# Движение нескольких моторов
poetry run python scripts/cli.py multi-move "1:500:1000:5000" "2:500:1000:3000"
```

## Симуляция моторов

MCU симулирует работу моторов с помощью SysTick таймера:
- Период тика: 1 мс
- Формула времени: `время_мс = steps / 1000`
- Пример: 5000 шагов = 5 секунд симуляции

В SYNC_MOVE команда блокируется до завершения всех моторов.
В ASYNC_MOVE команда возвращается сразу, состояние можно проверить через STATUS.
