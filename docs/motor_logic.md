# Логика работы моторов

## Обзор системы управления моторами

Система управления моторами использует четыре типа сигналов для каждого мотора:

### Сигналы управления моторами

#### EN (Enable) - Подача тока на моторы
- **Назначение**: Включает/выключает подачу тока на моторы
- **Состояние**: Включено ВСЕГДА по умолчанию
- **Отключение**: Только при срабатывании концевого выключателя (аварийная остановка)
- **Управление**: `GPIOC->ODR` (PC0-PC9)

#### KEY - Ключ для передачи данных мотору
- **Назначение**: Разрешает передачу данных конкретному мотору по UART4
- **Включение**: ТОЛЬКО перед передачей данных по UART4
- **Выключение**: Сразу после завершения передачи данных по DMA
- **Состояние по умолчанию**: Всегда = 0 (выключен)
- **Управление**: `GPIOB->ODR` (PB0-PB9)

#### SELECT - Выбор мотора для настройки
- **Назначение**: Указывает, какой мотор сейчас настраивается
- **Включение**: При начале настройки мотора
- **Выключение**: 
  - **Асинхронный режим**: Сразу после настройки
  - **Синхронный режим**: После настройки всех моторов
- **Управление**: `GPIOD->ODR` (PD0-PD9)

#### STATUS - Статус выполнения движения
- **Назначение**: Показывает состояние мотора
- **1**: Мотор выполняет движение
- **0**: Мотор ждет команду
- **Чтение**: `GPIOE->IDR` (PE0-PE9)

## Режимы работы

### Асинхронный режим
1. Настройка мотора:
   - Включается SELECT_x
   - Включается KEY_x
   - Передаются данные (ускорение, скорость, шаги)
   - Ждем STATUS = 1
   - Выключается KEY_x
   - Выключается SELECT_x
2. Мотор начинает движение сразу после настройки

### Синхронный режим
1. Настройка всех моторов:
   - Для каждого мотора:
     - Включается SELECT_x
     - Включается KEY_x
     - Передаются данные
     - Ждем STATUS = 1
     - Выключается KEY_x
     - SELECT_x остается включенным
2. Сохранение номеров моторов в переменную `syncMotorBuffer`
3. **Синхронный запуск всех моторов**:
   - Выключаются SELECT для всех моторов одновременно (`GPIOD->ODR &= ~syncMotorBuffer`)
   - KEY остается выключенным (не трогаем)
   - Все моторы начинают движение синхронно

## Передаваемые данные

Каждому мотору передаются следующие параметры:
- **Ускорение** (4 байта)
- **Максимальная скорость** (4 байта)  
- **Количество шагов** (4 байта)

## Аварийная остановка

При срабатывании концевого выключателя:
1. Все моторы выключаются (EN = 0)
2. Все SELECT сбрасываются
3. Все KEY сбрасываются
4. Система переходит в безопасный режим

## Схема подключения

```
EN_x    -> PCx (GPIOC) - подача тока на моторы
KEY_x   -> PBx (GPIOB) - ключ передачи данных
SELECT_x -> PDx (GPIOD) - выбор мотора для настройки
STATUS_x -> PEx (GPIOE) - статус движения мотора
```

Где x = номер мотора (0-9)

### Подробная схема:
- **EN сигналы**: PC0-PC9 (GPIOC) - всегда включены, отключаются только при аварии
- **KEY сигналы**: PB0-PB9 (GPIOB) - включаются перед передачей данных, выключаются после
- **SELECT сигналы**: PD0-PD9 (GPIOD) - включаются при настройке мотора
- **STATUS сигналы**: PE0-PE9 (GPIOE) - читаются для проверки готовности мотора
