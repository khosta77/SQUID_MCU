# STM32F407VG Motor Control Board Firmware

## Обзор проекта

Данный проект представляет собой прошивку для микроконтроллера STM32F407VG, предназначенную для управления до 10 шаговыми двигателями в синхронном и асинхронном режимах. Система обеспечивает высокоточное управление моторами через UART/USART протокол с поддержкой аварийной остановки и мониторинга состояния.

## Архитектура системы

### Общая схема взаимодействия

```
┌─────────────┐    USB/RS232    ┌─────────────┐    UART4     ┌─────────────┐
│     PC      │◄──────────────►│   FTDI      │◄───────────►│   STM32F407VG │
│   (Client)  │                │   FT232RL   │             │   (MCU)      │
└─────────────┘                └─────────────┘             └─────────────┘
                                                                    │
                                                                    │ USART2
                                                                    ▼
                                                           ┌─────────────┐
                                                           │   Motor     │
                                                           │  Drivers    │
                                                           │  (1-10)     │
                                                           └─────────────┘
```

### Компоненты системы

1. **PC (Client)** - отправляет команды управления моторами
2. **FTDI FT232RL** - мост USB ↔ USART для связи с микроконтроллером
3. **STM32F407VG** - основной микроконтроллер управления
4. **Motor Drivers** - драйверы шаговых двигателей (до 10 штук)

## Технические характеристики STM32F407VG

- **Процессор**: ARM Cortex-M4 с FPU
- **Тактовая частота**: 168 MHz
- **Flash память**: 1 MB
- **SRAM**: 192 KB + 64 KB CCM
- **GPIO порты**: A, B, C, D, E (до 114 пинов)
- **USART**: 6 каналов (используются UART4, USART2)
- **DMA**: 2 контроллера, 16 потоков
- **Прерывания**: EXTI, NVIC

## Протокол связи

### Формат команд (1 байт)

| Биты | Команда | Описание |
|------|---------|----------|
| `0b1000NNNN` | Синхронный запуск | Запуск всех ШД одновременно, N = количество моторов (1-10) |
| `0b0100NNNN` | Асинхронный запуск | Запуск по мере готовности, N = количество моторов (1-10) |
| `0b00100000` | Запрос версии | Получение информации о прошивке |

### Примеры команд

- `0x81` - синхронный запуск 1 мотора
- `0x82` - синхронный запуск 2 моторов
- `0x8A` - синхронный запуск 10 моторов
- `0x41` - асинхронный запуск 1 мотора
- `0x42` - асинхронный запуск 2 моторов
- `0x4A` - асинхронный запуск 10 моторов
- `0x20` - запрос версии прошивки

### Последовательность выполнения команды

1. **PC → MCU**: Отправка команды (1 байт)
2. **MCU → PC**: Подтверждение готовности (`0x00` или код ошибки)
3. **PC → MCU**: Отправка параметров моторов (N × 16 байт)
4. **MCU**: Обработка и выполнение команды
5. **MCU → PC**: Результат выполнения (`0xFF` - успех, код ошибки - неудача)

### Формат данных моторов (16 байт на мотор)

```
Байты 0-3:   number (uint32_t)     - номер мотора (1-10)
Байты 4-7:   acceleration (uint32_t) - ускорение
Байты 8-11:  maxSpeed (uint32_t)   - максимальная скорость
Байты 12-15: steps (uint32_t)      - количество шагов
```

## Подключение периферии

### GPIO назначения

#### GPIOA - UART/USART интерфейсы
- **PA0** - UART4_TX (связь с ПК)
- **PA1** - UART4_RX (связь с ПК)
- **PA2** - USART2_TX (связь с драйверами моторов)
- **PA3** - USART2_RX (связь с драйверами моторов)

#### GPIOB - Ключи управления моторами
- **PB0-PB9** - KEY1-10 (выходы для включения передачи данных в моторы)

#### GPIOC - Управление питанием драйверов
- **PC0-PC9** - EN1-10 (выходы для включения/отключения драйверов)

#### GPIOD - Выбор драйверов
- **PD0-PD9** - SELECT1-10 (выходы для выбора конкретного драйвера)
- **PD14** - Индикаторный светодиод

#### GPIOE - Статус и безопасность
- **PE0-PE9** - STATUS1-10 (входы статуса моторов, прерывания)
- **PE10-PE15** - ENDSTOP1-6 (концевые выключатели, аварийная остановка)

### DMA конфигурация

- **DMA1_Stream2** - UART4_RX (прием команд от ПК)
- **DMA1_Stream6** - USART2_TX (передача данных драйверам)

## Режимы работы

### Синхронный режим (0x8N)

1. Получение команды с количеством моторов
2. Настройка всех моторов по очереди:
   - Выбор драйвера (SELECT)
   - Включение драйвера (EN)
   - Отправка параметров через USART2
   - Ожидание готовности (STATUS)
   - Отключение драйвера
3. Одновременный запуск всех моторов через GPIO
4. Ожидание завершения всех моторов
5. Отправка результата

### Асинхронный режим (0x4N)

1. Получение команды с количеством моторов
2. Для каждого мотора:
   - Настройка драйвера
   - Немедленный запуск
3. Ожидание завершения всех моторов
4. Отправка результата

## Система безопасности

### Аварийная остановка

- **Триггер**: Любое прерывание ENDSTOP (PE10-PE15)
- **Действие**: Немедленное отключение всех EN (PC0-PC9)
- **Приоритет**: Высший (NVIC priority 0)
- **Результат**: Отправка кода ошибки `0x0B`

### Мониторинг состояния

- **STATUS пины** (PE0-PE9) отслеживают завершение движения моторов
- **Прерывания** по фронту сигнала STATUS
- **Глобальный флаг** завершения всех моторов

## Структура проекта

```
STM32F407VG_MOTOR_BOARD/
├── src/                         # Исходный код прошивки
│   ├── main.cpp                 # Главный файл, инициализация, обработчики прерываний
│   ├── motor_controller.cpp     # Логика управления моторами
│   ├── motor_controller.hpp     # Заголовочный файл контроллера
│   ├── motor_settings.cpp      # Реализация класса MotorSettings
│   ├── motor_settings.hpp      # Класс для параметров моторов
│   ├── constants.cpp           # Глобальные переменные состояния
│   ├── constants.hpp           # Константы протокола и версионирования
│   ├── gpio.cpp                # Инициализация GPIO
│   ├── gpio.hpp                # Заголовочный файл GPIO
│   ├── serial.cpp              # Инициализация UART/USART
│   ├── serial.hpp              # Заголовочный файл UART/USART
│   └── subdir.mk               # Конфигурация сборки
├── system/                      # Системные файлы CMSIS
│   ├── include/                # Заголовочные файлы STM32F407VG
│   └── src/                   # Системные исходники
├── docs/                       # Документация
│   ├── MotorManagerServicer_device_interface.md  # Протокол связи
│   ├── motor_logic.md         # Логика управления моторами
│   ├── scheme.pdf             # Схема подключения
│   ├── DS_STM32F407VG.pdf     # Datasheet микроконтроллера
│   └── RM_STM32F407VG.pdf     # Reference Manual
├── ldscripts/                  # Скрипты линковщика
│   ├── mem.ld                 # Распределение памяти
│   ├── libs.ld                # Библиотеки
│   └── sections.ld            # Секции памяти
├── makefile                    # Основной makefile
└── README.md                   # Данный файл
```

## Сборка и развертывание

### Требования

- **ARM GCC**: arm-none-eabi-gcc, arm-none-eabi-g++
- **Make**: GNU Make
- **Система**: macOS, Linux, Windows

### Сборка

```bash
# Сборка прошивки
make all

# Результат сборки
# - main.elf - исполняемый файл
# - main.hex - HEX файл для загрузки
# - main.bin - бинарный файл
# - main.map - карта памяти
```

### Размер прошивки

- **Код**: 14,908 байт
- **Данные**: 88 байт
- **BSS**: 1,032 байт
- **Общий размер**: 16,028 байт

## Отладка и мониторинг

### Индикация состояния

- **PD14** - светодиод (включен = система работает)
- **UART4** - отладочная информация и команды
- **STATUS пины** - состояние моторов
- **ENDSTOP пины** - аварийные ситуации

### Коды ошибок

| Код | Описание |
|-----|----------|
| `0x00` | Готовность к приему |
| `0x01` | Некорректное количество моторов |
| `0x02` | Некорректный режим работы |
| `0x0B` | Аварийная остановка |
| `0xFF` | Успешное выполнение |

## Дополнительные ресурсы

### Документация

- [STM32F407VG Datasheet](docs/DS_STM32F407VG.pdf)
- [STM32F407VG Reference Manual](docs/RM_STM32F407VG.pdf)
- [Протокол связи](docs/MotorManagerServicer_device_interface.md)
- [Схема подключения](docs/scheme.pdf)

### Полезные ссылки

- [ARM GCC Toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain)
- [CMSIS Documentation](https://arm-software.github.io/CMSIS_5/)
