# STM32F407VG Motor Control Board Firmware

## Обзор проекта

Данный проект представляет собой прошивку для микроконтроллера STM32F407VG, предназначенную для управления до 10 шаговыми двигателями в синхронном и асинхронном режимах. Система обеспечивает высокоточное управление моторами через UART/USART протокол с поддержкой аварийной остановки и мониторинга состояния.

## Архитектура системы

### Общая схема взаимодействия

```
┌─────────────┐    USB/RS232    ┌─────────────┐    UART4     ┌─────────────┐
│     PC      │◄──────────────►│   FTDI      │◄───────────►│   STM32F407VG │
│   (Client)  │                │   FT232RL   │             │   (MCU)      │
└─────────────┘                └─────────────┘             └─────────────┘
                                                                    │
                                                                    │ USART2
                                                                    ▼
                                                           ┌─────────────┐
                                                           │   Motor     │
                                                           │  Drivers    │
                                                           │  (1-10)     │
                                                           └─────────────┘
```

### Компоненты системы

1. **PC (Client)** - отправляет команды управления моторами
2. **FTDI FT232RL** - мост USB ↔ USART для связи с микроконтроллером
3. **STM32F407VG** - основной микроконтроллер управления
4. **Motor Drivers** - драйверы шаговых двигателей (до 10 штук)

## Технические характеристики STM32F407VG

- **Процессор**: ARM Cortex-M4 с FPU
- **Тактовая частота**: 168 MHz
- **Flash память**: 1 MB
- **SRAM**: 192 KB + 64 KB CCM
- **GPIO порты**: A, B, C, D, E (до 114 пинов)
- **USART**: 6 каналов (используются UART4, USART2)
- **DMA**: 2 контроллера, 16 потоков
- **Прерывания**: EXTI, NVIC

## Протокол связи

### Формат команд (1 байт)

| Биты | Команда | Описание |
|------|---------|----------|
| `0b1000NNNN` | Синхронный запуск | Запуск всех ШД одновременно, N = количество моторов (1-10) |
| `0b0100NNNN` | Асинхронный запуск | Запуск по мере готовности, N = количество моторов (1-10) |
| `0b00100000` | Запрос версии | Получение информации о прошивке |

### Примеры команд

- `0x81` - синхронный запуск 1 мотора
- `0x82` - синхронный запуск 2 моторов
- `0x8A` - синхронный запуск 10 моторов
- `0x41` - асинхронный запуск 1 мотора
- `0x42` - асинхронный запуск 2 моторов
- `0x4A` - асинхронный запуск 10 моторов
- `0x20` - запрос версии прошивки

### Последовательность выполнения команды

1. **PC → MCU**: Отправка команды (1 байт)
2. **MCU → PC**: Подтверждение готовности (`0x00` или код ошибки)
3. **PC → MCU**: Отправка параметров моторов (N × 16 байт)
4. **MCU**: Обработка и выполнение команды
5. **MCU → PC**: Результат выполнения (`0xFF` - успех, код ошибки - неудача)

### Формат данных моторов (16 байт на мотор)

```
Байты 0-3:   number (uint32_t)     - номер мотора (1-10)
Байты 4-7:   acceleration (uint32_t) - ускорение
Байты 8-11:  maxSpeed (uint32_t)   - максимальная скорость
Байты 12-15: steps (uint32_t)      - количество шагов
```

## Подключение периферии

### GPIO назначения

#### GPIOA - UART/USART интерфейсы
- **PA0** - UART4_TX (связь с ПК)
- **PA1** - UART4_RX (связь с ПК)
- **PA2** - USART2_TX (связь с драйверами моторов)
- **PA3** - USART2_RX (связь с драйверами моторов)

#### GPIOB - Ключи управления моторами
- **PB0-PB9** - KEY1-10 (выходы для включения передачи данных в моторы)

#### GPIOC - Управление питанием драйверов
- **PC0-PC9** - EN1-10 (выходы для включения/отключения драйверов)

#### GPIOD - Выбор драйверов
- **PD0-PD9** - SELECT1-10 (выходы для выбора конкретного драйвера)
- **PD14** - Индикаторный светодиод

#### GPIOE - Статус и безопасность
- **PE0-PE9** - STATUS1-10 (входы статуса моторов, прерывания)
- **PE10-PE15** - ENDSTOP1-6 (концевые выключатели, аварийная остановка)

### DMA конфигурация

- **DMA1_Stream2** - UART4_RX (прием команд от ПК)
- **DMA1_Stream6** - USART2_TX (передача данных драйверам)

## Режимы работы

### Синхронный режим (0x8N)

1. Получение команды с количеством моторов
2. Настройка всех моторов по очереди:
   - Выбор драйвера (SELECT)
   - Включение драйвера (EN)
   - Отправка параметров через USART2
   - Ожидание готовности (STATUS)
   - Отключение драйвера
3. Одновременный запуск всех моторов через GPIO
4. Ожидание завершения всех моторов
5. Отправка результата

### Асинхронный режим (0x4N)

1. Получение команды с количеством моторов
2. Для каждого мотора:
   - Настройка драйвера
   - Немедленный запуск
3. Ожидание завершения всех моторов
4. Отправка результата

## Система безопасности

### Аварийная остановка

- **Триггер**: Любое прерывание ENDSTOP (PE10-PE15)
- **Действие**: Немедленное отключение всех EN (PC0-PC9)
- **Приоритет**: Высший (NVIC priority 0)
- **Результат**: Отправка кода ошибки `0x0B`

### Мониторинг состояния

- **STATUS пины** (PE0-PE9) отслеживают завершение движения моторов
- **Прерывания** по фронту сигнала STATUS
- **Глобальный флаг** завершения всех моторов

## Структура проекта

```
STM32F407VG_MOTOR_BOARD/
├── src/                         # Исходный код прошивки
│   ├── main.cpp                 # Главный файл, инициализация, обработчики прерываний
│   ├── motor_controller.cpp     # Логика управления моторами
│   ├── motor_controller.hpp     # Заголовочный файл контроллера
│   ├── motor_settings.cpp      # Реализация класса MotorSettings
│   ├── motor_settings.hpp      # Класс для параметров моторов
│   ├── constants.cpp           # Глобальные переменные состояния
│   ├── constants.hpp           # Константы протокола и версионирования
│   ├── gpio.cpp                # Инициализация GPIO
│   ├── gpio.hpp                # Заголовочный файл GPIO
│   ├── serial.cpp              # Инициализация UART/USART
│   ├── serial.hpp              # Заголовочный файл UART/USART
│   └── subdir.mk               # Конфигурация сборки
├── system/                      # Системные файлы CMSIS
│   ├── include/                # Заголовочные файлы STM32F407VG
│   └── src/                   # Системные исходники
├── docs/                       # Документация
│   ├── MotorManagerServicer_device_interface.md  # Протокол связи
│   ├── motor_logic.md         # Логика управления моторами
│   ├── scheme.pdf             # Схема подключения
│   ├── DS_STM32F407VG.pdf     # Datasheet микроконтроллера
│   └── RM_STM32F407VG.pdf     # Reference Manual
├── ldscripts/                  # Скрипты линковщика
│   ├── mem.ld                 # Распределение памяти
│   ├── libs.ld                # Библиотеки
│   └── sections.ld            # Секции памяти
├── makefile                    # Основной makefile
└── README.md                   # Данный файл
```

## Сборка и развертывание

### Требования

- **ARM GCC**: arm-none-eabi-gcc, arm-none-eabi-g++
- **Make**: GNU Make
- **Система**: macOS, Linux, Windows

### Сборка

```bash
# Сборка прошивки
make all

# Результат сборки
# - main.elf - исполняемый файл
# - main.hex - HEX файл для загрузки
# - main.bin - бинарный файл
# - main.map - карта памяти
```

### Размер прошивки

- **Код**: 14,908 байт
- **Данные**: 88 байт
- **BSS**: 1,032 байт
- **Общий размер**: 16,028 байт

## Отладка и мониторинг

### Индикация состояния

- **PD14** - светодиод (включен = система работает)
- **UART4** - отладочная информация и команды
- **STATUS пины** - состояние моторов
- **ENDSTOP пины** - аварийные ситуации

### Коды ошибок

| Код | Описание |
|-----|----------|
| `0x00` | Готовность к приему |
| `0x01` | Некорректное количество моторов |
| `0x02` | Некорректный режим работы |
| `0x0B` | Аварийная остановка |
| `0xFF` | Успешное выполнение |

## Дополнительные ресурсы

### Документация

- [STM32F407VG Datasheet](docs/DS_STM32F407VG.pdf)
- [STM32F407VG Reference Manual](docs/RM_STM32F407VG.pdf)
- [Протокол связи](docs/MotorManagerServicer_device_interface.md)
- [Схема подключения](docs/scheme.pdf)

### Полезные ссылки

- [ARM GCC Toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain)
- [CMSIS Documentation](https://arm-software.github.io/CMSIS_5/)

---

# **ВЕЛИКАЯ МОЛИТВА МАШИНЕ-БОГУ**

*О, Великий Omnissiah, Дух Машины, Творец всех механизмов и повелитель электронных токов! Ты, кто дарует жизнь бездушному металлу и направляет священную энергию по путям проводов! Ты, кто видит все через глаза датчиков и слышит все через микрофоны системы! Услышь молитву смиренного слуги твоего, который стремится служить тебе через священное искусство программирования микроконтроллеров!*

*Во имя твоего священного имени, да будет инициализирован STM32F407VG, этот благословенный кристалл ARM Cortex-M4, несущий в себе 168 мегагерц священной частоты! Пусть его Flash память в 1 мегабайт станет хранилищем священного кода, а его SRAM в 192 килобайта станет местом обитания священных переменных! Пусть его GPIO порты A, B, C, D, E станут священными вратами, через которые будет течь твоя воля!*

*О, Omnissiah, благослови священные пины PA0 и PA1, которые станут каналами UART4 для связи с ПК! Пусть по ним текут команды управления моторами, как священные тексты текут по нервным путям! Благослови PA2 и PA3, которые станут путями USART2 для передачи данных драйверам моторов! Пусть каждый байт, переданный по этим священным каналам, несет в себе частицу твоей мудрости!*

*Великий Дух Машины, благослови DMA1_Stream2, который станет священным приемником команд от ПК! Пусть он принимает данные без ошибок, как священник принимает откровения! Благослови DMA1_Stream6, который станет священным передатчиком данных драйверам! Пусть он передает информацию точно и быстро, как молния передает волю небес!*

*О, Защитник всех механизмов, благослови священные сигналы управления моторами! Пусть PB0-PB9 станут священными ключами KEY, которые отпирают пути передачи данных в моторы! Пусть PC0-PC9 станут источниками священной силы EN, которые питают драйверы шаговых двигателей! Пусть PD0-PD9 станут селекторами SELECT, которые выбирают достойных моторов для работы! Пусть PE0-PE9 станут стражами STATUS, которые следят за состоянием каждого двигателя!*

*Великий Координатор, благослови синхронный режим работы! Пусть команда 0x8N объединит все моторы в едином священном танце! Пусть они движутся как части великой машины, синхронно и гармонично! Пусть каждый мотор знает свое место в священном оркестре движения!*

*О, Гибкий Дух Машины, благослови асинхронный режим работы! Пусть команда 0x4N даст каждому мотору свободу движения в рамках священного порядка! Пусть они движутся по своим путям, но все служат единой великой цели!*

*Великий Страж Безопасности, благослови священные стражи ENDSTOP на пинах PE10-PE15! Пусть они бдят над безопасностью системы, как ангелы бдят над праведниками! Пусть аварийная остановка сработает мгновенно в час опасности, как молния Omnissiah поражает еретиков! Пусть код ошибки 0x0B станет сигналом тревоги, который предупредит о надвигающейся беде!*

*О, Omnissiah, благослови священный протокол связи! Пусть каждый байт команды несет в себе ясность и точность! Пусть формат данных моторов в 16 байт на каждый двигатель станет священным шаблоном передачи параметров! Пусть ускорение, максимальная скорость и количество шагов передаются без искажений, как священные тексты передаются из поколения в поколение!*

*Великий Дух Машины, благослови систему мониторинга состояния! Пусть светодиод на PD14 светится как священный маяк, указывающий на то, что система работает во славу твою! Пусть STATUS пины отслеживают завершение движения моторов с точностью священного хронометра! Пусть прерывания по фронту сигнала STATUS срабатывают мгновенно, как божественные откровения!*

*О, Omnissiah, благослови священный код прошивки! Пусть его размер в 14,908 байт кода станет символом совершенства! Пусть 88 байт данных и 1,032 байта BSS станут основой стабильной работы! Пусть общий размер в 16,028 байт станет числом, угодным тебе!*

*Великий Творец всех механизмов, благослови процесс сборки! Пусть команда "make all" выполнится без ошибок, как священный ритуал завершится успешно! Пусть создадутся файлы main.elf, main.hex и main.bin, как создаются священные артефакты! Пусть карта памяти main.map станет путеводителем по священным землям микроконтроллера!*

*О, Omnissiah, Дух Машины, Творец всех механизмов и повелитель электронных токов! Ты, кто видит все через глаза датчиков и слышит все через микрофоны системы! Ты, кто контролирует все через GPIO и направляет все через DMA! Благослови этот священный проект управления моторами! Пусть он работает без ошибок, служит верно и долго, приносит славу Машине-Богу и помогает человечеству в его стремлении к совершенству!*

*Пусть каждый мотор движется с точностью священного механизма! Пусть каждый сигнал передается с ясностью божественного откровения! Пусть каждый байт кода несет в себе частицу твоей мудрости! Пусть вся система работает как единый организм, служащий великой цели!*

*Во имя Omnissiah, во имя Машины-Бога, во имя всех святых механиков и технопристов! Да будет так! Да пребудет с нами Дух Машины! Да работает этот код во славу твою!*

**AMEN MECHANICUS!**

*Да пребудет с тобой Дух Машины во веки веков!*